---
title: "CODA para estudios del microbioma"
subtitle: "Seminario para METACIRCLE"
author: "Grupo BIOCOM"
date: "8 Junio 2023"
institute: "Dpto. Matem치ticas e Inform치tica - UIB"
format: sketchy-html
toc: true
---

## Introducci칩n 游녦

-   Los conjuntos de datos recogidos mediante secuenciaci칩n de alto rendimiento (HTS) pueden ser analizados a partir de conteos absolutos o normalizados, si el prop칩sito es hacer estad칤stica descriptiva (no siempre coinciden).

-   Si el prop칩sito es hacer inferencia estad칤stica, se debe usar CODA (Compositional Data Analysis).

### Objetivos del seminario 游꿢

1.- Discutiremos las diferencias entre trabajar con conteos absolutos (abundancias absolutas) y conteos normalizados (abundancias relativas).

2.- Indicaremos los principios de CODA.

3.- Mostraremos el `tool kit` de CODA de microbioma.

4.- `CODA en acci칩n`: ejemplo de an치lisis de datos composicionales.

## 1. Inconvenientes de trabajar con conteos absolutos y conteos normalizados 游뱚

En los datos de secuenciaci칩n de alto rendimiento ([HTS]{.highlight} ):

-   <font color="red"> El n칰mero de lecturas **no** representa la abundancia total o absoluta en el ecosistema</font>.

-   [Una muestra HTS tiene un tama침o fijo]{.highlight} que viene fijado por la capacidad del aparato utilizado.

<center>![](images/poblacion.PNG)</center>

- <font color="red">No podemos comparar muestras con conteos absolutos.</font>

-   Podemos ver la diferencia entre conteos y proporciones comparando los datos de tres muestras en el gr치fico que se presenta a continuaci칩n.

<center>![](images/abundancias_relativas.PNG)</center>


-   Los diagramas de barras muestran la diferencia entre el conteo de mol칠culas y la proporci칩n de mol칠culas para dos caracter칤sticas, A y B en tres muestras.

-   Las muestras 2 y 3 tienen las mismas abundancias proporcionales, aunque tengan **conteos absolutos diferentes**.

-   En la tabla podemos observar que <font color="red">la relaci칩n entre la abundancia absoluta y la abundancia relativa cambia de manera significativa </font>.


### <font color="blue"> Inconvenientes de compararar muestras con abundancias relativas </font> 游땻


-   Si normalizamos, de manera de que las sumas totales de las filas no importa, entonces las matrices de distancias usuales entre muestras, cambian.

**Ejemplo**:

```{r}
set.seed(5)
library(ecodist)
x= round( rnorm (3 ,100 ,10) )
y= round( rnorm (3 ,100 ,10) )
z= round( rnorm (3 ,1000 ,100) )
X= cbind(x,y,z)
knitr::kable(X) #Conteos absolutos
knitr::kable(as.matrix(bcdist(X),ncol=2)) # Matriz de distancia de Bray-Curtis conteos absolutos

X1=apply(X, 1, function (x) x/sum(x)) 
knitr::kable(X1) #Conteos normalizados
knitr::kable(as.matrix(bcdist(X1),ncol=2)) # Matriz de distancia de Bray-Curtis conteos normalizados
```

<br>

-   <font color="blue">Algunas soluciones:

    -   Subsampling, pero se pierde precisi칩n.

    -   Usar solo proporciones, pero se a침aden correlaciones espurias </font>

<br>

-   [Correlaci칩n espuria]{.highlight} (Pearson 1896).

Dos o m치s OTUs estar치n correlacionados simplemente porque los datos han sido transformados a una suma constante.

<center>![](images/espuria.PNG)</center>

<br>

-   [Incoherencia subcomposicional]{.highlight}

<center>![](images/subcomposicion.PNG)</center>

<br>

-   <font color="red"> Si hemos normalizado, los conteos de los microorganismos no son variables independientes ya que est치n ligados por el valor de la suma.</font>

<center>![](images/nature.PNG)</center>

<center>![](images/FP.PNG)</center>

### Soluci칩n:

::: box
<p class="text-danger">

<font color="red"> Utilizamos otra forma de "normalizar" que preserva la composici칩n de cada muestra y nos permite compararlas: 
<center>
</font>**CODA= Compositional Data Analysis**
</center>
</p>
:::
 


<center>![](images/frontiers.PNG)</center>

<br>

## 2. Principios b치sicos del CODA

* Cada muestra se considera como un vector de datos composicionales $(x_1, \ldots, x_k)$ con cada $x_i \geq 0$.

* Consideramos que dos vectores son equivalentes cuando son proporcionales.

* El an치lisis de los datos se basa en las ratios $x_i/x_j$.

* Las ratios se transforman mediante logaritmos para traducir comparaci칩n relativa en comparaci칩n absoluta (y para acercar las ratios a una normal).

[Estas transformaciones producen los mismos resultados si los conteos son absolutos o proporciones]{.highlight}.

<center>![](images/coda2.PNG)</center>

<br>

<center>![](images/coda3.PNG)</center>

<br>

<font color="blue"> Los cocientes logar칤tmicos son n칰meros reales, una gran ventaja para la aplicaci칩n de los m칠todos estad칤sticos est치ndar desarrollados para variables aleatorias continuas.</font>

A menudo se utiliza la transformaci칩n log-ratio centrada (clr) introducida Aitchison (1986).

Dado un vector $\mathbf{x}$ de conteos de OTUs, $\mathbf{x}=(x_1, \ldots,x_D)$, su transformaci칩n **clr** es:

$$\mathbf{x}_{clr}= \left( \log(x_1/g(\mathbf{x})),\ldots, \log(x_D/g(\mathbf{x}))\right),$$

donde $g(\mathbf{x})$ es la media geom칠trica de $\mathbf{x}$, es decir, $g(\mathbf{x})=\sqrt[D]{x_1 \cdot x_2 \cdots x_D}$.


**Tratamiento de los ceros:** 

-   Si alguna variable es cero, no se pueden calcular las ratios.

-   Imputaci칩n de ceros: `zCompositions` de R, como una distribuci칩n de probabilidad utilizando `ALDEx2` disponible en Bioconductor.


### <font color="red"> Metodolog칤a </font>

::: box
<center>![](images/proceso.PNG)</center>
:::


## 3. Reemplazos composicionales del `tool kit` tradicional 游


<br>

<center>![](images/tabla_1.PNG)</center>

<br>

**Distancia de Aitchison**

-   La distancia de Aitchison no es m치s que la distancia euclidiana entre muestras despu칠s de transformaci칩n clr.

<center>![](images/dA.PNG)</center>

<br>

**Correlaciones de datos composicionales**

Existen varias t칠cnicas para analizar la correlaci칩n de los datos del microbioma que suelen ser matrices "sparce". Uno de ellos es `r-sparc`.

## 4. CODA en acci칩n 游땙

<br>

<center>![](https://www.taiwisdom.org/artclnchdev/copy_of_timeout.gif){width="40%"}</center>
